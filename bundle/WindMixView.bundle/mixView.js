/* mix-view-adaptor (min) v0.4.0, build at 2020-07-14 16:31. */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e["mix-view-adaptor"]=t()}(this,function(){"use strict";"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{writable:!0,enumerable:!1,configurable:!0,value:function(e){var t=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),r=1;r<arguments.length;r++){var i=t[r];if(null!=i)for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(n[o]=i[o])}return n}});var t,u='object[type="application/view"]',c='div[type="application/view"][original-type="object"]',s="mixviewcallback",d="query",x="data-object-id",l="data-observed",v=(t=Date.now()%999999,function(e){return void 0===e&&(e="mix_view"),e+"_"+t++});function f(){return"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:new Function("return this")()}function r(){var e=f();return e&&e.__mix_view_environment__}function n(){return{r:(99999999*Math.random()|0)%256,g:(99999999*Math.random()|0)%256,b:(99999999*Math.random()|0)%256,a:.01}}function p(e){return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"}var i,h=(i={},function(){for(var e=n(),t=p(e);i[t];)t=p(e=n());return i[t]=e});function o(r,i){var o;return void 0===i&&(i=0),"function"!=typeof setTimeout||"function"!=typeof clearTimeout?r:function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];var n=this;clearTimeout(o),o=setTimeout(function(){return r.apply(n,e)},i)}}function a(){return"object"==typeof process&&process&&process.env&&"test"===process.env.PURPOSE}function m(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function b(e){return Object.prototype.toString.call(e).slice(8,-1)}function g(e){return"Object"===b(e)}function y(e){return"Function"===b(e)}function _(e){return e&&1===e.nodeType}function w(){var e=r();return e&&"color"===e.matchType}function A(e){var t=r();return!(!g(t.availableTypes)||!m(t.availableTypes,e))}function E(e){return"type"===e||"viewType"===e}function j(e){return w()?_(e)&&/^object$/i.test(e.nodeName)&&"application/view"===String(e.getAttribute("type")).toLowerCase()&&"object"===String(e.getAttribute("original-type")).toLowerCase():_(e)&&/^object$/i.test(e.nodeName)&&"application/view"===String(e.getAttribute("type")).toLowerCase()}function C(e){return _(e)&&/^param$/i.test(e.nodeName)}function T(e){return!1!==e&&0!==e&&!e||"undefined"==e||"null"==e||"NaN"==e}function e(){var e=r();return e&&"string"==typeof e.platform&&"android"===e.platform.toLowerCase()}function O(){var e=f(),t=r();return e&&void 0!==e.AFAppX||t&&"yes"===String(t.isForAppX).toLowerCase()}function L(){return O()?"1":"0"}var N=["all","debug","log","warn","error","silent"],S="warn",P=function(e,t){var n,r="["+((n=e).charAt(0).toUpperCase()+n.slice(1))+"][mix_view] "+t;if("function"==typeof console[e]&&"debug"!==e)return console[e](r);console.log(r)};function M(e){if(a())return"function"==typeof __test_logger__&&(P=__test_logger__,1);var t=r(),n=t&&t.logLevel||S;return N.indexOf(e)>=N.indexOf(n)}function k(e){M("debug")&&P("debug",e)}function q(e){M("warn")&&P("warn",e)}function D(e){M("error")&&P("error",e)}function F(){}F.prototype.postMessage=function(e){if(e&&e.length){var t=f();try{k("Post message: "+JSON.stringify(e)),t.webkit.messageHandlers.mixView.postMessage(e)}catch(e){D("Failed to postMessage: "+e.toString())}}},F.prototype.onmessage=function(t,n){void 0===n&&(n="mixviewevent"),f().addEventListener(n,function(e){k('Receive event "'+n+'": '+JSON.stringify(e.data)),e&&g(e.data)&&"function"==typeof t&&t(e.data)})};var I=function(e){function t(){e.call(this)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.postMessage=function(e){if(e&&e.length){var t=f();try{k("Post message (on Android): "+JSON.stringify(e)),t.mixView.postMessage(e)}catch(e){D("Failed to postMessage (on Android): "+e.toString())}}},t}(F),V="[[EVENT_MAP]]";function R(e,t){var n=e[V];return Array.isArray(n[t])||(n[t]=[]),n[t]}function $(){Object.defineProperty(this,V,{configurable:!1,enumerable:!1,writable:!1,value:{}})}$.prototype.on=function(e,t){return R(this,e).push({listener:t,once:!1,callCount:0}),this},$.prototype.once=function(e,t){return R(this,e).push({listener:t,once:!0,callCount:0}),this},$.prototype.off=function(e,t){var n,r,i=this[V];return t?(n=i[e],!Array.isArray(n)||-1!==(r=n.findIndex(function(e){return e.listener===t}))&&n.splice(r,1)):delete i[e],this},$.prototype.emit=function(t){for(var n=[],e=arguments.length-1;0<e--;)n[e]=arguments[e+1];var r=this[V],i=r[t];return Array.isArray(i)&&(r[t]=i.filter(function(e){try{e.listener.apply(null,n),e.callCount+=1}catch(e){return D('Failed to emit "'+t+'" event.\n'+e.toString()),!0}return!e.once})),this};var J=new(e()?I:F),U=new $;function H(e,t,n){return t+"_"+n+"@"+e}function z(o,a){o[a]=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return k('Call the "'+a+'" method on '+o.tagName+"#"+o.id),new Promise(function(n,r){var i=v();U.once(H(o.id,a,i),function(e){var t;k('Receive callback of "'+a+'" on '+o.tagName+"#"+o.id+" (id: "+i+")."),g(e)?(!function(e){if(g(e)&&m(e,"success")){if("string"==typeof e.success)switch(e.success.toLowerCase()){case"true":case"1":return 1;case"false":case"0":return}return e.success}}(e)?r:n)(e.data):(D(t='Invalid message format of the "'+a+'" callback!'),r(new Error(t)))}),J.postMessage([{id:o.id,action:"callMethod",name:a,args:e,callbackId:i}]),J.onmessage(function(e){var t=e.id,n=e.name,r=e.callbackId;U.emit(H(t,n,r),e)},s)})};try{Object.defineProperty(o[a],a,{value:a})}catch(e){}}function X(t,e){_(t)&&"Array"===b(e)&&(k('Register native methods on "'+t.tagName+"#"+t.id+'" ('+e.join(", ")+")."),e.forEach(function(e){z(t,e)}))}var Q=["border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius","border-radius"],W=["style","class",l,x];function B(e){var t={};if(e.hasAttributes())for(var n=0;n<e.attributes.length;++n){var r=e.attributes[n];-1===W.indexOf(r.name)&&(t[r.name]=r.value)}return t}function G(e,t){void 0===t&&(t={}),k("Start parse the <"+e.tagName+' id="'+e.id+'"> element');var n="",r={};if(e.children)for(var i=0;i<e.children.length;++i){var o,a=e.children[i];C(a)&&(E(o=a.getAttribute("name"))?A(n=a.getAttribute("value"))||D('The "'+n+'" view type is not supported!'):r[o]=B(a),k('Set "'+x+'" of <'+a.tagName+' name="'+o+'"> to be "'+e.id+'".'),a.setAttribute(x,e.id))}var s=[];for(var u in e){var c=/^on([a-z]+)$/.exec(u);c&&c[1]&&y(e[u])&&s.push(c[1])}var d={type:n,viewType:n,styles:function(e){var t=f();if(t&&"function"==typeof t.getComputedStyle){var n=t.getComputedStyle(e),r={};return Q.forEach(function(e){r[e]=n.getPropertyValue(e)}),r}return{}}(e),backgroundColor:t.backgroundColor};return Object.keys(r).length&&(d.params=r),s.length&&(d.events=s),d}function K(r,i){var o=r,a=[];o._events=Object.create(null);function e(e){var t,n=/^on([a-z]+)$/.exec(e);n&&n[1]&&(t=n[1],o._events[t]=r[e],Object.defineProperty(r,e,{enumerable:!0,configurable:!0,get:function(){return o._events[t]},set:function(e){y(i)&&i(t,e,o._events[t]),o._events[t]=e}}),y(r[e])&&a.push(t))}for(var t in r)e(t);return a}function Y(e,r,i){m(e,"addEventListener")||(e._addEventListener=e.addEventListener,Object.defineProperty(e,"addEventListener",{writable:!0,enumerable:!0,configurable:!0,value:function(e,t,n){y(r)&&r(e,this),this._addEventListener(e,t,n)}})),m(e,"removeEventListener")||(e._removeEventListener=e.removeEventListener,Object.defineProperty(e,"removeEventListener",{writable:!0,enumerable:!0,configurable:!0,value:function(e,t,n){y(i)&&i(e,this),this._removeEventListener(e,t,n)}}))}var Z=["title","style","class",l,x];function ee(t){return new MutationObserver(function(e){var N=[];e.forEach(function(e){var t,n,r,i,o,a,s,u=e.type,c=e.attributeName,d=e.oldValue,l=e.target;if(1===l.nodeType)switch(u){case"attributes":var v,f,p,h,m=l.getAttribute(c);s=c,!j(a=l)&&!C(a)||-1!==Z.indexOf(s)||((i=d)==(o=m)||T(i)&&T(o))||(k('Captured "'+c+'" attribute change of <'+l.nodeName+'> (old: "'+d+'", new: "'+m+'").'),j(l)?(v={id:l.id,appx:L(),action:"setAttributes",args:[((t={})[c]=m,t)]},N.push(v)):C(l)&&(f=l.getAttribute(x),p=l.getAttribute("name"),h=B(l),k('The "'+p+'" param of #'+f+" object is changed to "+JSON.stringify(h)+"."),N.push({id:f,action:"setParams",args:[((n={})[p]=h,n)]})));break;case"childList":if(!j(l))break;var b=e.addedNodes,g=e.removedNodes;if(k("Captured params change of <"+l.nodeName+"> (added: "+b.length+", removed: "+g.length+")."),b.length)for(var y,_,w=0;w<b.length;++w){C(b[w])&&(_=(y=b[w]).getAttribute("name"),y.setAttribute(x,l.id),k("Captured newly inserted <"+y.nodeName+' name="'+_+'"> and set its "'+x+'" to be "'+l.id+'".'),N.push({id:l.id,action:"setParams",args:[((r={})[_]=B(y),r)]}))}if(g.length)for(var A,E,O=0;O<g.length;++O){C(g[O])&&(E=(A=g[O]).getAttribute("name"),k("Captured the <"+A.nodeName+' name="'+E+'"> has been deleted.'),N.push({id:A.getAttribute(x),action:"removeParams",args:[E]}))}}}),t(N)})}function te(e,t){if(void 0===t&&(t="div"),!e.parentNode)return q("The <"+e.tagName+"> element is offline, can't replace its tagName."),e;if(e.tagName.toLowerCase()===t.toLowerCase())return e;for(var n=document.createElement(t),r=0,i=e.attributes.length;r<i;++r){var o=e.attributes.item(r).nodeName,a=e.attributes.item(r).nodeValue;n.setAttribute(o,a)}for(;e.firstChild;)n.appendChild(e.firstChild);return e.parentNode.replaceChild(n,e),n}function ne(e){for(var t=[],n=0;n<e.length;++n){var r=e[n];if("function"==typeof r.matches&&(r.matches(u)||r.matches(c))&&-1===t.indexOf(r)&&t.push(r),"function"==typeof r.querySelectorAll){for(var i=r.querySelectorAll(u),o=0;o<i.length;++o)-1===t.indexOf(i[o])&&t.push(i[o]);for(var a=r.querySelectorAll(c),s=0;s<a.length;++s)-1===t.indexOf(a[s])&&t.push(a[s])}}return t}function re(){this._label=v("manager"),this._views=Object.create(null),this._messages=Object.create(null),this._observers=Object.create(null),e()?this._bridge=new I:this._bridge=new F,this._setup()}function ie(){var t=new re;k("Setup MixView Manager "+t.label()),function(t,n,e){void 0===e&&(e=!0);var r=f();try{Object.defineProperty(r,t,{value:n,configurable:!0,enumerable:!0,writable:!e})}catch(e){r[t]=n}}("__mix_view_manager__",t),document.addEventListener("DOMContentLoaded",function(){t.observeDocument(),t.queryAndObserve()}),setTimeout(function(){t.observeDocument(),t.queryAndObserve();var e=setInterval(function(){t.queryAndObserve()},3e3);setTimeout(function(){return clearInterval(e)},1e4)},0)}return re.prototype._isObserved=function(e){return!(!e||e.getAttribute(l)!=this._label)},re.prototype._setup=function(){var s=this;!function(){if(!O()){var e=r();return e&&!e.disableDebounce}}()?this.send=this._sendMessages:(k("Add 30ms debounce for manager.send()"),this.send=o(function(){return s._sendMessages()},30));var u=this.queryAndObserve=function(){k("Start query and observe mix views. (observing: "+Object.keys(s._views).join(", ")+")"),s.query(),s.observe(),s.send()};this._bridge.onmessage(function(e){var t,n,r,i=e.id,o=e.name,a=e.data;o!=d?s._views[i]&&(k('Dispatch "'+o+'" event on "#'+i+'".'),t=s._views[i].element,(n=new CustomEvent(o,{detail:a})).data=a,t.dispatchEvent(n)):(k('Query element of "'+i+'" ('+d+")"),u(),(r=s._views[i])&&r.options?(k('Found listening element of "'+i+'" (type: '+r.options.viewType+")"),s.schedule([{id:i,appx:L(),action:"queryElement",args:[r.options]}]),s._sendMessages()):q("Can't find element of \""+i+'".'))});function e(e,t){j(t)&&(s.schedule([{id:t.id,appx:L(),action:"addEvent",args:[e]}]),s.send())}function t(e,t){j(t)&&(s.schedule([{id:t.id,appx:L(),action:"removeEvent",args:[e]}]),s.send())}Y(HTMLObjectElement.prototype,e,t),w()&&Y(HTMLDivElement.prototype,e,t)},re.prototype._parseInlineEvent=function(e){var r=this,i=e.id,t=K(e,function(e,t,n){y(t)&&!y(n)?r.schedule([{id:i,appx:L(),action:"addEvent",args:[e]}]):!y(t)&&y(n)&&r.schedule([{id:i,appx:L(),action:"removeEvent",args:[e]}]),r.send()});t.length&&(this.schedule([{id:i,appx:L(),action:"addEvent",args:t}]),this.send())},re.prototype._registerMethods=function(e,t){var n=r();n&&g(n.availableTypes)&&X(e,n.availableTypes[t])},re.prototype._sendMessages=function(){var e=[];for(var t in this._messages){var n=this._messages[t];for(var r in n){var i={id:t,appx:L(),action:r};m(n,r)&&n[r]&&(i.args=n[r]),e.push(i),delete n[r]}delete this._messages[t]}e.length&&this._bridge.postMessage(e)},re.prototype.label=function(){return this._label},re.prototype.shouldDowngrade=function(e){return!r()||!(!_(e)||A(function(e){if(j(e)&&e.children.length)for(var t=0;t<e.children.length;++t){var n=e.children[t];if(C(n)&&E(n.getAttribute("name")))return n.getAttribute("value")}return C(e)&&E(e.getAttribute("name"))?e.getAttribute("value"):""}(e)))&&(e.dispatchEvent(new Event("error")),!0)},re.prototype.query=function(){var t=this,e=function(e){void 0===e&&(e=function(){return!0});for(var t={},n=ne([document]),r=0;r<n.length;++r){var i,o,a,s=n[r];1===s.nodeType&&e(s)&&(k("Found the <"+s.nodeName+"> element (#"+s.id+") and start to preprocess it."),i=s.tagName.toLowerCase(),w()&&"div"!==i&&(q("The <"+i+"> element is not supported in current environment, it will be replaced by a <div> element."),(s=te(s,"div")).setAttribute("original-type",i)),o=v(),s.id?t[s.id]&&(q('The id "'+s.id+'" of <'+s.nodeName+'> has already been used, it will be replaced by "'+o+'".'),s.id=o,s.setAttribute("id",o)):(s.id=o,s.setAttribute("id",o)),a=h(),s.style["-webkit-transform"]="translate3d(0,0,0)",s.style["background-color"]=p(a),t[s.id]={options:G(s,{backgroundColor:a}),element:s})}return t}(function(e){return e&&!t._views[e.id]});for(var n in e)this._views[n]||(this._views[n]=e[n]);return this},re.prototype.observe=function(){var t=this;for(var e in this._views){var n,r=this._views[e],i=r.options,o=r.element;this._observers[e]||(k("Start to observe the <"+o.tagName+"> element (#"+o.id+")."),this._parseInlineEvent(o),this._registerMethods(o,i.viewType||i.type),(n=ee(function(e){t.schedule(e),t.send()})).observe(o,{attributes:!0,attributeOldValue:!0,childList:!0,subtree:!0}),this._observers[e]=n,o.setAttribute(l,this._label),this.schedule([{id:e,appx:L(),action:"createElement",args:[i]}]))}return this},re.prototype.schedule=function(e){var c=this;return e.forEach(function(e){var t=e.id,n=e.action,r=e.args;m(c._messages,t)||(c._messages[t]=Object.create(null));var i=c._messages[t];if(m(i,n)&&r?(-1!==["setParams","setAttributes","setStyles"].indexOf(n)&&r.forEach(function(e,t){i[n][t]?Object.assign(i[n][t],e):i[n][t]=e}),-1!==["removeParams","removeAttributes","removeStyles","addEvent","removeEvent"].indexOf(n)&&r.forEach(function(e){-1===i[n].indexOf(e)&&i[n].push(e)})):i[n]=r,m(i,"createElement")&&m(i,"removeElement")&&(delete i.createElement,delete i.removeElement),m(i,"createElement")&&i.createElement[0]){var o,a=i.createElement[0];if(m(i,"addEvent")&&(o=i.addEvent,Array.isArray(o)&&(a.events&&Array.isArray(a.events)?o.forEach(function(e){-1===a.events.indexOf(e)&&a.events.push(e)}):a.events=o),delete i.addEvent),m(i,"removeEvent")&&a.events){for(var s=0;s<i.removeEvent.length;++s){var u=a.events.indexOf(i.removeEvent[s]);-1!==u&&a.events.splice(u,1)}delete i.removeEvent}m(i,"setParams")&&(i.setParams.forEach(function(e){a.params=Object.assign({},a.params,e)}),delete i.setParams),m(i,"removeParams")&&a.params&&(i.removeParams.forEach(function(e){delete a.params[e]}),delete i.removeParams)}}),this},re.prototype.observeDocument=function(e){var t,s=this;if(void 0===e&&(e=document.body),e)return this._isObserved(e)?this.cleanUp(e):(t=new MutationObserver(function(e){e.forEach(function(e){var t=e.type,n=e.target,r=e.addedNodes,i=e.removedNodes;if("childList"===t&&1===n.nodeType){k("Captured element tree change of <"+n.nodeName+"> (added: "+r.length+", removed: "+i.length+").");var o=ne(i);if(o.length)for(var a=0;a<o.length;++a)s.stopObserve(o[a]);(r.length||o.length)&&s.queryAndObserve()}})}),k("Start observe the root element <"+e.tagName+">."),t.observe(e,{childList:!0,subtree:!0}),e.setAttribute(l,this._label)),this;q('No available "document.body", will try again!')},re.prototype.stopObserve=function(e){var t;return j(e)&&this._isObserved(e)&&(t=e.id,k("Stop observe <"+e.tagName+"> (#"+t+")."),delete this._views[t],delete this._messages[t],this._observers[t]&&(this._observers[t].disconnect(),delete this._observers[t]),e.removeAttribute(l),this.schedule([{id:t,appx:L(),action:"removeElement"}])),this},re.prototype.cleanUp=function(e){if(void 0===e&&(e=document.body),k("Will clean up observed elements."),e&&!this._isObserved(e)){e.removeAttribute(l);for(var t=ne([e]),n=0;n<t.length;++n)if(1===t[n].nodeType){var r=t[n],i=r.id;k("Remove observe flags on <"+r.tagName+"> (#"+i+")."),delete this._views[i],delete this._messages[i],this._observers[i]&&(this._observers[i].disconnect(),delete this._observers[i]),r.removeAttribute("original-type"),r.removeAttribute(l);for(var o,a=r.querySelectorAll("param"),s=0;s<a.length;++s){1===a[s].nodeType&&(k("Remove observe flags on <"+(o=a[s]).tagName+"> (#"+o.id+")."),o.removeAttribute(x),o.removeAttribute(l))}}}},a()||ie(),ie});
